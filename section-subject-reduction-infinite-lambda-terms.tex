
\section{Subject Reduction for Well-Typed Infinite Lambda Terms}
\label{section-subject-reduction}

We show the subject reduction for well-typed terms of $\LAMBDA$,
and also show the global trace condition is preserved by reductions. 
We first introduce some auxiliary notations for proofs of them.

Let $X$ be a set of variables.
We write $\Gamma_X$ be $\{x^T:T \in \Gamma \mid x^T \in X \}$.
Let $\Gamma$ and $\Delta$ be contexts of $\LAMBDA$.
We say that $\Gamma$ and $\Delta$ are {\em consistent} if 
$\Gamma_{\FV(\Gamma)\cap\FV(\Delta)} \sim \Delta_{\FV(\Gamma)\cap\FV(\Delta)}$. 
The merged context $\mergeCtx{\Gamma}{\Delta}$
is defined by $\Gamma\conc\Delta_{\FV(\Delta)\setminus\FV(\Gamma)}$
if $\Gamma$ and $\Delta$ are consistent, and is undefined otherwise. 

Let $S_1 = \Gamma_1\vdash t_1:\vec{B_1}\rightarrow N$
and $S_2 = \Gamma_2\vdash t_2:\vec{B_2}\rightarrow N$ be sequents. 
Let $k_1$ and $k_2$ be indexes of $N$-arguments of $t_1$ and $t_2$, respectively. 
Then we write $(k_1,S_1) \simIndex (k_2,S_2)$ (or $(k_1,t_1) \simIndex (k_2,t_2)$ for short) if $k_1$ and $k_2$ are those of named arguments with the same name,
or $k_1$ and $k_2$ are those of unnamed arguments at the same position
in $\vec{B_1}$ and $\vec{B_2}$, respectively. 
Note that the index equivalent to $k_1$ is unique (if it exists), namely 
$(k_1,t_1) \simIndex (k_2,t_2)$ and $(k_1,t_1) \simIndex (k'_2,t_2)$ implies $k_2=k'_2$. 

\begin{lemma}\label{lem:thinning}
  Assume $\Pi:\Gamma\vdash t:A$.
  Then $\Pi':\Gamma_{\FV(t)}\vdash t:A$ for some $\Pi'$.
  Moreover if the global trace condition holds for $\Pi$, then it also holds for $\Pi'$. 
\end{lemma}
\begin{proof}
  Let $\Pi$ be $(T,\phi)$.
  For each $l \in T$, we write $\Gamma_l\vdash t_l:A_l$
  for the conclusion of $\phi(l) \in \Rule$. 
  Then we construct $\Pi'=(T,\phi')$,
  whose set of nodes is the same as that of $\Pi$. 
  For each $l\in T$, we define $\phi'(l)$ and $\Gamma'_l$ that satisfies
  the following requirements:
  \begin{itemize}
  \item[(a)]
    $\Gamma'_l\vdash t_l:A_l$ is the conclusion of $\phi'(l) \in \Rule$,
  \item[(b)]
    $\Restrict{(\Gamma_l)}{\FV(t_l)} \subseteqsim \Gamma'_l \subseteqsim \Gamma_l$
    and $\Gamma'_{\nil} = \Restrict{\Gamma}{\FV(t)}$, 
  \item[(c)]
    if $\tilde{k},t_{l\conc(i)}$ is the successor of $k,t_l$ in $\Pi$
    and $k$ is an index of some unname argument
    or a named argument of some name $z\in\FV(t_l)$, 
    then there are $\tilde{k'}$ and $k'$ such that
    $\tilde{k'},t_{l\conc(i)}$ is the successor of $k',t_l$ in $\Pi'$, 
    $(k,t_l) \simIndex (k',t_l)$,
    and $(\tilde{k},t_{l\conc(i)}) \simIndex (\tilde{k'},t_{l\conc(i)})$.
    Moreover, if $k$ is an index of a progressing argument, then so is $k'$.
  \end{itemize}
  Note that the proof is done if we construct $\Pi'$ that satisfies these requirements. 
  
  We define $\Gamma'_{\nil} = \Restrict{\Gamma}{\FV(t)}$.
  Then it satisfies (b) since $t_\nil = t$. 
  Next, assuming the induction hypothesis that $\Gamma'_l$ that satisfies (b)
  is already defined, 
  we define $\phi'(l)$ and $\Gamma_{l\conc(i)}$, 
  for each $i$ such that $l\conc(i)\in T$, 
  that satisfies (a), (b), and (c). 
  It is done by the case analysis of $\phi(l)$.

  The case that $\phi(l) = \Gamma_l\vdash x:A_l$,
  which is an instance of the rule $\var$ with $x:A_l\in\Gamma_l$. 
  Then define $\phi'(l) = \Gamma'_l\vdash x:A_l$. This is an instance of $\var$
  because $\{x:A_l\} = \Restrict{(\Gamma_l)}{\{x\}} \subseteqsim \Gamma'_l$ by (b).

  The case that $\phi(l) = (\Gamma_{l\conc(1)}\vdash t_l:A_l,\Gamma_{l}\vdash t_l:A_l)$,
  which is an instance of the rule $\weak$ with
  $t_{l\conc(1)} = t_l$, $A_{l\conc(1)} = A_{l}$, and
  $\Gamma_{l\conc(1)}\subseteqsim \Gamma_l$.
  Let $\psi$ be the unique map that determines $\Gamma_{l\conc(1)}\subseteqsim \Gamma_l$.
  Then define $\Gamma'_{l\conc(1)}$ such that
  $\Gamma'_{l\conc(1)}\subseteqsim \Gamma'_l$ determined by
  the induced map from $\psi$ restricting the range to $\FV(\Gamma'_l)$.
  Note that $\FV(\Gamma'_{l\conc(1)}) = \FV(\Gamma'_l)\cap\FV(\Gamma_{l\conc(1)})$. 
  Then it satisfies (b) since $\FV(t_l)\subseteq \FV(\Gamma'_l) \cap \FV(\Gamma_{l\conc(1)}) = \FV(\Gamma'_{l\conc(1)}) \subseteq \FV(\Gamma_{l\conc(1)})$ by (b) for $\Gamma'_l$.
  Define $\phi'(l) = (\Gamma'_{l\conc(1)}\vdash t_l:A_l,\Gamma'_{l}\vdash t_l:A_l)$
  as an instance of the rule $\weak$. 
  Hence the requirement (a) holds.
  We can also show (c): if $k$ is an index in $\Gamma_l\vdash t_l:A_l$ for a name
  $z\in\FV(t_{l\conc(1)}) = \FV(t_l)$, then we can take an index $k'$
  in $\Gamma'_l\vdash t_l:A_l$ for $z$ by $\FV(t_l)\subseteq\FV(\Gamma'_l)$ by (b). 
  An index $\tilde{k'}$ for the name $z$ can be taken
  from $\Gamma'_{l\conc(1)}\vdash t_l:A_l$
  since $z \in \FV(t_l) \subseteq \FV(\Gamma'_{l\conc(1)})$. 
  
  The case that $\phi(l)$ is an instance of the rule $\lambda$
  whose conclusion is $\Gamma_l\vdash\lambda z^C.b:C,\vec{B}\to N$
  with $A_l=C,\vec{B}\to N$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l,z:C$.
  This is possible since $\Gamma_l,z:C$ is consistent
  and $\Gamma'_l\subseteqsim \Gamma_l$ by (b) for $\Gamma'_l$.
  Then define
  $\phi'(l) = (\Gamma'_{l},z:C\vdash b:\vec{B}\to N, \Gamma'_l\vdash \lambda z.b:C,\vec{B}\to N)$
  as an instance of the rule $\lambda$. 
  Then we have (a). 
  We also have (b) for $\Gamma'_{l\conc(1)}$
  since $\FV(b) \subseteq \FV(\lambda z.b) \cup \{z\} \subseteq \FV(\Gamma'_l)\cup\{z\} = \FV(\Gamma'_{l\conc(1)}) \subseteq \FV(\Gamma_l)\cup\{z\} = \FV(\Gamma_{l\conc(1)})$.
  The requirement (c) holds: 
  if $k$ is an index of some named argument $y\in\FV(\lambda z.b)$ in $\Gamma_l$,
  then $k'$ can be taken as the index of $y$ in $\Gamma'_l$ by (b) for $\Gamma_l$.
  If $k$ is an index of some unnamed argument in $C,\vec{B}$,
  then $k'$ can be taken as the index of some unnamed argument. 
  In both cases, their successors $\tilde{k}$ and $\tilde{k'}$ are uniquely
  determined by $k$ and $k'$, respectively. 
  
  The case that $\phi(l)$ is an instance of the rule $\apvar$
  whose conclusion is $\Gamma_l\vdash f(x^B):\vec{C}\to N$ with $x:B\in \Gamma_l$.  
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l$.
  This satisfies (b) by the induction hypothesis. 
  Then define
  $\phi'(l) = (\Gamma'_{l\conc(1)}\vdash f:B,\vec{C}\to N, \Gamma'_l\vdash f(x^B):\vec{C}\to N)$
  as an instance of the rule $\apvar$. This satisfies (a). 
  In order to show (c), 
  take an index $k$ for $\Gamma_l\vdash f(x^B):\vec{C}\to N$, which is the one for
  a named argument $y \in \FV(f(x^B))$ in $\Gamma_l$
  or for some unnamed argument of $\vec{C}$. 
  For the latter case, the indexes $\tilde{k}$, $k'$ and $\tilde{k'}$ can be taken
  as those of the unnamed argument in $\vec{C}$ at the same position as $k$.
  For the former case, we take $k'$ as the index for $y$ in $\Gamma'_l$.
  In order to take $\tilde{k'}$,
  we further have two subcases according to $\tilde{k}$: 
  The first one is $\tilde{k}$ is the index for the same named argument as $k$, 
  and the second one is $\tilde{k}$ is the index for the unnamed argument, namely $B=N$.
  In both subcases, we can take the equivalent $\tilde{k'}$ to $\tilde{k}$ as we wished.
    
  The case that $\phi(l)$ is an instance of the rule $\apnotvar$
  whose conclusion is $\Gamma_l\vdash f(b^B):A_l$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_{l\conc(2)} = \Gamma'_l$.
  This satisfies (b) by the induction hypothesis.
  Then define $\phi'(l) = (S_1, S_2, \Gamma'_l\vdash f(b^B):\vec{C}\to N)$,
  where $S_1$ is $\Gamma'_{l}\vdash f:B,\vec{C}\to N$
  and $S_2$ is $\Gamma'_{l}\vdash b:B$, as an instance of $\apnotvar$.
  This satisfies (a).
  In order to show (c), 
  take an index $k$ for $\Gamma_l\vdash f(x^B):\vec{C}\to N$, which is the one for
  a named argument $y \in \FV(f(x^B))$ in $\Gamma_l$
  or for some unnamed argument of $\vec{C}$.
  For the former case, the successor $\tilde{k}$ of $k$ is uniquely taken.
  By $\FV(f(b)) \subseteq \FV(\Gamma'_l)$, the index $k'$ equivalent to $k$ is uniquely taken. 
  Then the successor $\tilde{k'}$ of $k'$ is also taken as we wished. 
  For the latter case, the successor $\tilde{k}$ of $k$ is uniquely taken
  as the one for unnamed argument at the same position as $k$. 
  Then $k'$ equivalent to $k$ is uniquely taken, and 
  its successor $\tilde{k'}$ is also taken as we wished. 

  The case that $\phi(l)$ is an instance of the rule $0$
  whose conclusion is $\Gamma_l\vdash 0:N$. 
  Define $\phi'(l) = \Gamma'_l\vdash 0:N$ as an instance of the rule $0$.
  This satisfies the requirements (a), (b), and (c). 

  The case that $\phi(l)$ is an instance of the rule $\Succ$
  whose conclusion is $\Gamma_l\vdash \Succ(t_{l\conc(1)}):N$ with $A_l=N$.
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l$, and 
  $\phi'(l) = (\Gamma'_l\vdash t_{l\conc(1)}:N, \Gamma'_l\vdash \Succ(t_{l\conc(1)}):N)$
  as an instance of $\Succ$. They satisfy (a) and (b). 
  The requirement (c) is also satisfied:
  Take an index $k$ for $\Gamma_l\vdash \Succ(t_{l\conc(1)}): N$,
  which is the one for a named argument $y \in \FV(\Succ(t_{l\conc(1)})$ in $\Gamma_l$.
  Then the successor $\tilde{k}$ of $k$ is uniquely taken.  
  By $\FV(t_{l\conc(1)}) \subseteq \FV(\Gamma'_l)$, the index $k'$ equivalent to $k$ is uniquely taken. 
  Then the successor $\tilde{k'}$ of $k'$ is also taken as we wished. 
  
  The case that $\phi(l)$ is an instance of the rule $\cond$
  whose conclusion is $\Gamma_l\vdash \cond(f,g):N,\vec{C}\to N$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_{l\conc(2)} = \Gamma'_l$, and 
  $\phi'(l) = (S_1,S_2, \Gamma'_l\vdash \cond(f,g):N,\vec{C}\to N)$,
  where $S_1$ is $\Gamma'_l\vdash f:\vec{C}\to N$ and $S_2$ is $\Gamma'_l \vdash g:N,\vec{C}\to N$, 
  as an instance of $\cond$. They satisfy (a) and (b). 
  To show (c), take an index $k$ for $\Gamma_l\vdash \cond(f,g): N,\vec{C}\to N$ as required. 
  We need to consider three cases:
  $k$ is the index for a named argument $y \in \FV(\cond(f,g))$ in $\Gamma_l$,
  is the one for an unnamed argument in $\vec{C}$, or
  is the one for an unnamed argument in $N$ (the first one of $N,\vec{C}\to N$). 
  For the first and second cases, we can take $\tilde{k}$, $k'$, and $\tilde{k'}$
  similar to the other cases.
  For the last case, the successor $\tilde{k}$ of $k$ should be taken
  as the index of the unnamed $N$-argument of $\Gamma'_l \vdash g:N,\vec{C}\to N$
  at the same position as $k$. 
  Then $k'$ and $\tilde{k'}$ are taken as those equivalent to $k$ and $\tilde{k}$, respectively.
  Note that this $k$ is an index of a progressing argument $N$, and so is $k'$. 
\end{proof}



\begin{lemma}[Substitution lemma]
  Assume that $\Pi_u: \Gamma_u \vdash u:A$ and $\Pi_t:\Gamma_t,x:A \vdash t:B$ hold,
  and $\Gamma_u$ and $\Gamma_t$ are consistent. 
  Then there exists $\Pi^*$ such that $\Pi^*:\mergeCtx{\Gamma_u}{\Gamma_t} \vdash t[u/x]:B$. 
  Moreover, if $\Pi_u$ and $\Pi_t$ satisfy the global trace condition,
  then $\Pi^*$ also satisfies it. 
\end{lemma}
\begin{proof}


\end{proof}

\begin{lemma}\label{lem:inversion}
  \begin{enumerate}
  \item\label{lem:inversion1}
    If $\Pi:\Gamma\vdash f(a):A$ and $\Pi$ satisfies the global trace condition, then
    there exist $\Pi_1$, $\Pi_2$ and $B$ such that
    $\Pi_1:\Gamma\vdash f:B\to A$, $\Pi_2:\Gamma\vdash a:B$,
    and both $\Pi_1$ and $\Pi_2$ satisfy the global trace condition. 
  \item\label{lem:inversion2}
    If $\Pi:\Gamma\vdash \lambda x^T.b:A$, where $x\not\in\FV(\Gamma)$,
    and $\Pi$ satisfies the global trace condition, then
    there exist $\Pi_1$ and $B$ such that
    $\Pi_1:\Gamma,x:T\vdash b:B$ and $A = T\to B$,
    and $\Pi_1$ satisfies the global trace condition. 
  \item\label{lem:inversion3}
    If $\Pi:\Gamma\vdash \cond(f,g):A$ and $\Pi$ satisfies the global trace condition, then
    there exist $\Pi_1$, $\Pi_2$ and $B$ such that
    $\Pi_1:\Gamma \vdash f:B$, $\Pi_2:\Gamma \vdash g:N\to B$, $A = N\to B$,
    and both $\Pi_1$ and $\Pi_2$ satisfy the global trace condition. 
  \item\label{lem:inversion4}
    If $\Pi:\Gamma\vdash \Succ(t):A$ and $\Succ(t) \in \GTC$, then    
    there exists $\Pi_1$ such that $\Pi_1:\Gamma \vdash t:N$, $A=N$, 
    and $\Pi_1$ satisfies the global trace condition. 
  \end{enumerate}
\end{lemma}
\begin{proof}
  We first claim that if $t\in\GTC$ and $\Pi:\Gamma\vdash t:A$ with $\Pi=(T,\phi)$, 
  then there exists $l\in T$ such that $\phi(l) \neq \weak$ and $\phi(m) = \weak$ for all $m < l$.
  Because, if not, the only infinite path in $\Pi$ is the consective use of $\weak$,
  which does not contain progressing trace, this contradicts with $t\in\GTC$.

  We show the point \ref{lem:inversion1}.
  Assume that $\Pi:\Gamma\vdash f(a):A$ with $\Pi=(T,\phi)$ and $f(a) \in \GTC$.
  By the claim, take $l\in T$ such that $\phi(l) \neq \weak$ and $\phi(m) = \weak$ for all $m < l$.
  Let $\Gamma' \vdash f(a):A$ be the conclusion of $\phi(l)$. Then $\Gamma'\subseteqsim \Gamma$ holds
  by the transitivity of $\subseteqsim$.
  Now $\phi(l)$ is $\apvar$ or $\apnotvar$.
  In the former case $\phi(l) = \apvar$, we have $\Pi\restr l\conc(1):\Gamma'\vdash f:B\to A$ for some $B$,
  and $a = x^B \in \Gamma'$. Hence we have a proof $\Pi_1:\Gamma\vdash f:B\to A$ by $\weak$. 
  We also obtain $\Pi_2:\Gamma\vdash a:B$ by $a = x^B \in \Gamma'$ and $\weak$. 
  In the latter case $\phi(l) = \apnotvar$,
  we have $\Pi\restr l\conc(1):\Gamma'\vdash f:B\to A$ and $\Pi\restr l\conc(2):\Gamma'\vdash a:B$ for some $B$. 
  Hence we have a proof $\Pi_1:\Gamma\vdash f:B\to A$ and $\Pi_2:\Gamma\vdash a:B$ by $\weak$.
  In both cases, if $t\in\GTC$, we have $f\in\GTC$ and $a\in\GTC$ by the construction of $\Pi_1$ and $\Pi_2$. 
  
  The points \ref{lem:inversion2}, \ref{lem:inversion3}, and \ref{lem:inversion4} are shown similarly. 
\end{proof}


\begin{theorem}[Subject reduction]
  Assume that $\Pi_t:\Gamma\vdash t:A$, $\Pi_t$ satisfies the global trace condition, and $t\reduces u$.
  Then there exists $\Pi_u$ such that $\Pi_u:\Gamma\vdash u:A$ and $\Pi_u$ satisfies the global trace condition. 
\end{theorem}
\begin{proof}
  By the definition of $t\reduces u$, there is a context $\hat{t}[-]$ such that
  $t=\hat{t}[t_0]$, $u=\hat{t}[u_0]$, and $t_0\reduces_\Box u_0$, where $\Box\in\{\beta,\cond\}$. 
  Since $t_0$ is a subterm of $t$, there is $l$ such that $\Pi_t\restr l: \Gamma_0\vdash t_0:A_0$.
  Note that $\Pi_t\restr l$ satisfies the global trace condition,
  since it is a subtree of $\Pi_t$, which satisfies the global trace condition. 
  Then, if we have $\Pi'_u:\Gamma_0\vdash u_0:A_0$ that satisfies the global trace condition,
  the tree obtained from $\Pi_t$ by replacing the subtree $\Pi_t\restr l$ by $\Pi'_u$ is also
  a proof of $\Gamma\vdash \hat{t}[u_0]:A$ that satisfies the global trace condition. 
  Hence it is enough to show the following:
  \begin{itemize}
  \item[(a)]
    If $\Pi:\Gamma \vdash (\lambda x^A.b)(a): B$ and it satisfies the global trace condition,
    then $\Pi':\Gamma \vdash b[a/x]: B$ for some $\Pi'$ that satisfies the global trace condition.
  \item[(b)]
    If $\Pi:\Gamma \vdash \cond(f,g)(0): B$ and it satisfies the global trace condition,
    then $\Pi':\Gamma \vdash f: B$ for some $\Pi'$ that satisfies the global trace condition. 
  \item[(c)]
    If $\Pi:\Gamma \vdash \cond(f,g)(\Succ(t)): B$ and it satisfies the global trace condition,
    then $\Pi':\Gamma \vdash g(t): B$ for some $\Pi'$ that satisfies the global trace condition. 
  \end{itemize}
  (b) is shown immediately by Lemma~\ref{lem:inversion}~\ref{lem:inversion3}.
  We show (c).
  Assume $\Pi:\Gamma \vdash \cond(f,g)(\Succ(t)): B$.
  Then by \ref{lem:inversion1}, \ref{lem:inversion3}, and \ref{lem:inversion4} of Lemma~\ref{lem:inversion},
  we have
  $\Pi_1:\Gamma \vdash g:N\to B$ and $\Pi_2:\Gamma \vdash t:N$,
  where $\Pi_1$ and $\Pi_2$ satisfy the global trace condition. 
  Hence, by applying $\apnotvar$ or $\apvar$ to $\Pi_1$ and $\Pi_2$, 
  we have a proof $\Pi':\Gamma\vdash g(t):B$ that satisfies the global trace condition. 
  In order to show (a), assume $\Pi:\Gamma \vdash (\lambda x^A.b)(a): B$.
  Then by Lemma~\ref{lem:inversion}~\ref{lem:inversion1},
  we have $\Pi_1:\Gamma \vdash \lambda x^A.b:A\to B$ and $\Pi_2:\Gamma \vdash a:A$,
  where $\Pi_1$ and $\Pi_2$ satisty the global trace condition. 
  Then, by Lemma~\ref{lem:thinning},
  we have $\Pi'_1:\Restrict{\Gamma}{\FV(\lambda x.b)} \vdash \lambda x^A.b:A\to B$,
  where $\Pi'$ satisfies the global trace condition. 
  By Lemma~\ref{lem:inversion}~\ref{lem:inversion2},
  we have a proof $\Pi''_1:\Restrict{\Gamma}{\FV(\lambda x.b)},x:A \vdash b:B$
  that satisfies the global trace condition. 
  Hence, by the substitution lemma, we have a proof $\Pi':\Gamma\vdash b[a/x]:B$
  that satisfies the global trace condition, as we wished. 
  
  
  

  

\end{proof}
