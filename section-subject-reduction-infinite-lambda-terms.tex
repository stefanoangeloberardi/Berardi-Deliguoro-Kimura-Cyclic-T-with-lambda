
\section{Subject Reduction for Well-Typed Infinite Lambda Terms}
\label{section-subject-reduction}

We show the subject reduction for well-typed terms of $\LAMBDA$,
and also show the global trace condition is preserved by reductions. 
We first introduce some auxiliary notations for proofs of them.

Let $X$ be a set of variables.
We write $\Gamma_X$ be $\{x^T:T \in \Gamma \mid x^T \in X \}$.
Let $\Gamma$ and $\Delta$ be contexts of $\LAMBDA$.
We say that $\Gamma$ and $\Delta$ are {\em consistent} if 
$\Gamma_{\FV(\Gamma)\cap\FV(\Delta)} \sim \Delta_{\FV(\Gamma)\cap\FV(\Delta)}$. 
The merged context $\Gamma\sharp\Delta$
is defined by $\Gamma\conc\Delta_{\FV(\Delta)\setminus\FV(\Gamma)}$
if $\Gamma$ and $\Delta$ are consistent, and is undefined otherwise. 

Let $S_1 = \Gamma_1\vdash t_1:\vec{B_1}\rightarrow N$
and $S_2 = \Gamma_2\vdash t_2:\vec{B_2}\rightarrow N$ be sequents. 
Let $k_1$ and $k_2$ be indexes of $N$-arguments of $t_1$ and $t_2$, respectively. 
Then we write $(k_1,S_1) \simIndex (k_2,S_2)$ (or $(k_1,t_1) \simIndex (k_2,t_2)$ for short) if $k_1$ and $k_2$ are those of named arguments with the same name,
or $k_1$ and $k_2$ are those of unnamed arguments at the same position
in $\vec{B_1}$ and $\vec{B_2}$, respectively. 
Note that the index equivalent to $k_1$ is unique (if it exists), namely 
$(k_1,t_1) \simIndex (k_2,t_2)$ and $(k_1,t_1) \simIndex (k'_2,t_2)$ implies $k_2=k'_2$. 

\begin{lemma}
  Assume $\Pi:\Gamma\vdash t:A$.
  Then $\Pi':\Gamma_{\FV(t)}\vdash t:A$ for some $\Pi'$.
  Moreover if the global trace condition holds for $\Pi$, then it also holds for $\Pi'$. 
\end{lemma}
\begin{proof}
  Let $\Pi$ be $(T,\phi)$.
  For each $l \in T$, we write $\Gamma_l\vdash t_l:A_l$
  for the conclusion of $\phi(l) \in \Rule$. 
  Then we construct $\Pi'=(T,\phi')$,
  whose set of nodes is the same as that of $\Pi$. 
  For each $l\in T$, we define $\phi'(l)$ and $\Gamma'_l$ that satisfies
  the following requirements:
  \begin{itemize}
  \item[(a)]
    $\Gamma'_l\vdash t_l:A_l$ is the conclusion of $\phi'(l) \in \Rule$,
  \item[(b)]
    $\Restrict{(\Gamma_l)}{\FV(t_l)} \subseteqsim \Gamma'_l \subseteqsim \Gamma_l$
    and $\Gamma'_{\nil} = \Restrict{\Gamma}{\FV(t)}$, 
  \item[(c)]
    if $\tilde{k},t_{l\conc(i)}$ is the successor of $k,t_l$ in $\Pi$
    and $k$ is an index of some unname argument
    or a named argument of some name $z\in\FV(t_l)$, 
    then there are $\tilde{k'}$ and $k'$ such that
    $\tilde{k'},t_{l\conc(i)}$ is the successor of $k',t_l$ in $\Pi'$, 
    $(k,t_l) \simIndex (k',t_l)$,
    and $(\tilde{k},t_{l\conc(i)}) \simIndex (\tilde{k'},t_{l\conc(i)})$.
    Moreover, if $k$ is an index of a progressing argument, then so is $k'$.
  \end{itemize}
  Note that the proof is done if we construct $\Pi'$ that satisfies these requirements. 
  
  We define $\Gamma'_{\nil} = \Restrict{\Gamma}{\FV(t)}$.
  Then it satisfies (b) since $t_\nil = t$. 
  Next, assuming the induction hypothesis that $\Gamma'_l$ that satisfies (b)
  is already defined, 
  we define $\phi'(l)$ and $\Gamma_{l\conc(i)}$, 
  for each $i$ such that $l\conc(i)\in T$, 
  that satisfies (a), (b), and (c). 
  It is done by the case analysis of $\phi(l)$.

  The case that $\phi(l) = \Gamma_l\vdash x:A_l$,
  which is an instance of $(\var)$-rule with $x:A_l\in\Gamma_l$. 
  Then define $\phi'(l) = \Gamma'_l\vdash x:A_l$. This is an instance of $(\var)$-rule
  because $\{x:A_l\} = \Restrict{(\Gamma_l)}{\{x\}} \subseteqsim \Gamma'_l$ by (b).

  The case that $\phi(l) = (\Gamma_{l\conc(1)}\vdash t_l:A_l,\Gamma_{l}\vdash t_l:A_l)$,
  which is an instance of $(\weak)$-rule with
  $t_{l\conc(1)} = t_l$, $A_{l\conc(1)} = A_{l}$, and
  $\Gamma_{l\conc(1)}\subseteqsim \Gamma_l$.
  Let $\psi$ be the unique map that determines $\Gamma_{l\conc(1)}\subseteqsim \Gamma_l$.
  Then define $\Gamma'_{l\conc(1)}$ such that
  $\Gamma'_{l\conc(1)}\subseteqsim \Gamma'_l$ determined by
  the induced map from $\psi$ restricting the range to $\FV(\Gamma'_l)$.
  Note that $\FV(\Gamma'_{l\conc(1)}) = \FV(\Gamma'_l)\cap\FV(\Gamma_{l\conc(1)})$. 
  Then it satisfies (b) since $\FV(t_l)\subseteq \FV(\Gamma'_l) \cap \FV(\Gamma_{l\conc(1)}) = \FV(\Gamma'_{l\conc(1)}) \subseteq \FV(\Gamma_{l\conc(1)})$ by (b) for $\Gamma'_l$.
  Define $\phi'(l) = (\Gamma'_{l\conc(1)}\vdash t_l:A_l,\Gamma'_{l}\vdash t_l:A_l)$
  as an instance of $(\weak)$. 
  Hence the requirement (a) holds.
  We can also show (c): if $k$ is an index in $\Gamma_l\vdash t_l:A_l$ for a name
  $z\in\FV(t_{l\conc(1)}) = \FV(t_l)$, then we can take an index $k'$
  in $\Gamma'_l\vdash t_l:A_l$ for $z$ by $\FV(t_l)\subseteq\FV(\Gamma'_l)$ by (b). 
  An index $\tilde{k'}$ for the name $z$ can be taken
  from $\Gamma'_{l\conc(1)}\vdash t_l:A_l$
  since $z \in \FV(t_l) \subseteq \FV(\Gamma'_{l\conc(1)})$. 
  
  The case that $\phi(l)$ is an instance of $(\lambda)$-rule
  whose conclusion is $\Gamma_l\vdash\lambda z^C.b:C,\vec{B}\to N$
  with $A_l=C,\vec{B}\to N$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l,z:C$.
  This is possible since $\Gamma_l,z:C$ is consistent
  and $\Gamma'_l\subseteqsim \Gamma_l$ by (b) for $\Gamma'_l$.
  Then define
  $\phi'(l) = (\Gamma'_{l},z:C\vdash b:\vec{B}\to N, \Gamma'_l\vdash \lambda z.b:C,\vec{B}\to N)$ as an instance of $(\lambda)$. 
  Then we have (a). 
  We also have (b) for $\Gamma'_{l\conc(1)}$
  since $\FV(b) \subseteq \FV(\lambda z.b) \cup \{z\} \subseteq \FV(\Gamma'_l)\cup\{z\} = \FV(\Gamma'_{l\conc(1)}) \subseteq \FV(\Gamma_l)\cup\{z\} = \FV(\Gamma_{l\conc(1)})$.
  The requirement (c) holds: 
  if $k$ is an index of some named argument $y\in\FV(\lambda z.b)$ in $\Gamma_l$,
  then $k'$ can be taken as the index of $y$ in $\Gamma'_l$ by (b) for $\Gamma_l$.
  If $k$ is an index of some unnamed argument in $C,\vec{B}$,
  then $k'$ can be taken as the index of some unnamed argument. 
  In both cases, their successors $\tilde{k}$ and $\tilde{k'}$ are uniquely
  determined by $k$ and $k'$, respectively. 
  
  The case that $\phi(l)$ is an instance of $(\apvar)$-rule
  whose conclusion is $\Gamma_l\vdash f(x^B):\vec{C}\to N$ with $x:B\in \Gamma_l$.  
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l$.
  This satisfies (b) by the induction hypothesis. 
  Then define
  $\phi'(l) = (\Gamma'_{l\conc(1)}\vdash f:B,\vec{C}\to N, \Gamma'_l\vdash f(x^B):\vec{C}\to N)$
  as an instance of $(\apvar)$. This satisfies (a). 
  In order to show (c), 
  take an index $k$ for $\Gamma_l\vdash f(x^B):\vec{C}\to N$, which is the one for
  a named argument $y \in \FV(f(x^B))$ in $\Gamma_l$
  or for some unnamed argument of $\vec{C}$. 
  For the latter case, the indexes $\tilde{k}$, $k'$ and $\tilde{k'}$ can be taken
  as those of the unnamed argument in $\vec{C}$ at the same position as $k$.
  For the former case, we take $k'$ as the index for $y$ in $\Gamma'_l$.
  In order to take $\tilde{k'}$,
  we further have two subcases according to $\tilde{k}$: 
  The first one is $\tilde{k}$ is the index for the same named argument as $k$, 
  and the second one is $\tilde{k}$ is the index for the unnamed argument, namely $B=N$.
  In both subcases, we can take the equivalent $\tilde{k'}$ to $\tilde{k}$ as we wished.
    
  The case that $\phi(l)$ is an instance of $(\apnotvar)$-rule
  whose conclusion is $\Gamma_l\vdash f(b^B):A_l$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_{l\conc(2)} = \Gamma'_l$.
  This satisfies (b) by the induction hypothesis.
  Then define $\phi'(l) = (S_1, S_2, \Gamma'_l\vdash f(b^B):\vec{C}\to N)$,
  where $S_1$ is $\Gamma'_{l}\vdash f:B,\vec{C}\to N$
  and $S_2$ is $\Gamma'_{l}\vdash b:B$, as an instance of $(\apnotvar)$.
  This satisfies (a).
  In order to show (c), 
  take an index $k$ for $\Gamma_l\vdash f(x^B):\vec{C}\to N$, which is the one for
  a named argument $y \in \FV(f(x^B))$ in $\Gamma_l$
  or for some unnamed argument of $\vec{C}$.
  For the former case, the successor $\tilde{k}$ of $k$ is uniquely taken.
  By $\FV(f(b)) \subseteq \FV(\Gamma'_l)$, the index $k'$ equivalent to $k$ is uniquely taken. 
  Then the successor $\tilde{k'}$ of $k'$ is also taken as we wished. 
  For the latter case, the successor $\tilde{k}$ of $k$ is uniquely taken
  as the one for unnamed argument at the same position as $k$. 
  Then $k'$ equivalent to $k$ is uniquely taken, and 
  its successor $\tilde{k'}$ is also taken as we wished. 

  The case that $\phi(l)$ is an instance of $(0)$-rule
  whose conclusion is $\Gamma_l\vdash 0:N$. 
  Define $\phi'(l) = \Gamma'_l\vdash 0:N$ as an instance of $(0)$.
  This satisfies the requirements (a), (b), and (c). 

  The case that $\phi(l)$ is an instance of $(\Succ)$-rule
  whose conclusion is $\Gamma_l\vdash \Succ(t_{l\conc(1)}):N$ with $A_l=N$.
  Define $\Gamma'_{l\conc(1)} = \Gamma'_l$, and 
  $\phi'(l) = (\Gamma'_l\vdash t_{l\conc(1)}:N, \Gamma'_l\vdash \Succ(t_{l\conc(1)}):N)$
  as an instance of $(\Succ)$. They satisfy (a) and (b). 
  The requirement (c) is also satisfied:
  Take an index $k$ for $\Gamma_l\vdash \Succ(t_{l\conc(1)}): N$,
  which is the one for a named argument $y \in \FV(\Succ(t_{l\conc(1)})$ in $\Gamma_l$.
  Then the successor $\tilde{k}$ of $k$ is uniquely taken.  
  By $\FV(t_{l\conc(1)}) \subseteq \FV(\Gamma'_l)$, the index $k'$ equivalent to $k$ is uniquely taken. 
  Then the successor $\tilde{k'}$ of $k'$ is also taken as we wished. 
  
  The case that $\phi(l)$ is an instance of $(\cond)$-rule
  whose conclusion is $\Gamma_l\vdash \cond(f,g):N,\vec{C}\to N$. 
  Define $\Gamma'_{l\conc(1)} = \Gamma'_{l\conc(2)} = \Gamma'_l$, and 
  $\phi'(l) = (S_1,S_2, \Gamma'_l\vdash \cond(f,g):N,\vec{C}\to N)$,
  where $S_1$ is $\Gamma'_l\vdash f:\vec{C}\to N$ and $S_2$ is $\Gamma'_l \vdash g:N,\vec{C}\to N$, 
  as an instance of $(\cond)$. They satisfy (a) and (b). 
  To show (c), take an index $k$ for $\Gamma_l\vdash \cond(f,g): N,\vec{C}\to N$ as required. 
  We need to consider three cases:
  $k$ is the index for a named argument $y \in \FV(\cond(f,g))$ in $\Gamma_l$,
  is the one for an unnamed argument in $\vec{C}$, or
  is the one for an unnamed argument in $N$ (the first one of $N,\vec{C}\to N$). 
  For the first and second cases, we can take $\tilde{k}$, $k'$, and $\tilde{k'}$
  similar to the other cases.
  For the last case, the successor $\tilde{k}$ of $k$ should be taken
  as the index of the unnamed $N$-argument of $\Gamma'_l \vdash g:N,\vec{C}\to N$
  at the same position as $k$. 
  Then $k'$ and $\tilde{k'}$ are taken as those equivalent to $k$ and $\tilde{k}$, respectively.
  Note that this $k$ is an index of a progressing argument $N$, and so is $k'$. 
\end{proof}



\begin{lemma}[Substitution lemma]
  Assume that $\Pi_u: \Gamma \vdash u:A$ and $\Pi_t:\Gamma,x:A \vdash t:B$ hold.
  Then there exists $\Pi^*$ such that $\Pi^*:\Gamma \vdash t[u/x]:B$. 
  Moreover, if $\Pi_u$ and $\Pi_t$ satisfy the global trace condition,
  then $\Pi^*$ also satisfies it. 
\end{lemma}
\begin{proof}


\end{proof}


\begin{theorem}[Subject reduction]
  Assume that $\Pi_t:\Gamma\vdash t:A$ and $t\reduces u$.
  Then there exists $\Pi_u$ such that $\Pi_u:\Gamma\vdash u:A$ holds. 
  Moreover, if $\Pi_t$ satisfies the global trace condition,
  then $\Pi_u$ also satisfies it. 
\end{theorem}
\begin{proof}


\end{proof}
